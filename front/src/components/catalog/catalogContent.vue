<template>
    <div class="catalog-content">
        <div
            v-show="showMessage"
            :class="['message', {'bad' : !isGood || catalogItems.length === 0}]"
        >
            <div
                v-show="activeItems.categoriesIndex === 0 && catalogItems.length > 0"
                class="txt"
            >
                {{ messageContent.breakfast }}
            </div>
            <div
                v-show="activeItems.categoriesIndex === 1 && catalogItems.length > 0"
                class="txt"
            >
                {{ messageContent.businessLunch }}
            </div>
            <div
                v-show="catalogItems.length === 0"
                class="txt"
            >
                {{ messageContent.noDishes }}
            </div>
        </div>
        <div
            v-show="catalogItems.length > 0"
            :class="['categories-title',
            {'no-message' : !showMessage}]"
        >
            {{ activeItems.categoriesTitle }}
        </div>
        <div
            v-show="catalogItems.length > 0"
            class="subcategories-title"
        >
            {{ activeItems.subcategoriesTitle }}
        </div>
        <button
            v-show="catalogItems.length === 0"
            class="go-to-catalog"
            @click="goToCatalog"
        >
            Перейти в каталог
        </button>
        <div class="catalog-items">
            <catalogItem
                v-for="(catalogItem, index) in arrСonsideringСart"
                :key="index"
                :catalogItem="catalogItem"
                @inCart="inCart"
                @transformAmount="transformAmount"
            />
        </div>
    </div>
</template>

<script>
import catalogItem from "@/components/catalog/catalogItem/catalogItem.vue";
import {mapMutations, mapState} from 'vuex'

export default {
    name: "catalogContent",
    data() {
        return {
            messageContent: {
                breakfast: 'Завтраки действуют по будням с 8:00 — 12:00 / по выходным с 8:00 — 16:00',
                businessLunch: 'Бизнес-ланчи действуют по будням с 12:00 — 16:00',
                noDishes: 'К сожалению, по вашему запросу ничего не найдено'
            },
            isGood: true,
            componentCart: [],
            width: 0,
        }
    },
    computed: {
        ...mapState('cart', ['cart']),
        showMessage: function () {
            if (this.activeItems.categoriesIndex === 0 || this.activeItems.categoriesIndex === 1) {
                return true
            } else return this.catalogItems.length === 0;
        },
        arrСonsideringСart: function () {
            return this.catalogItems.map(item => {
                const cartItem = this.cart.find(cartItem => cartItem.id === item.id);
                this.$set(item, 'count', cartItem ? cartItem.count : 0);
                return item;
            });
        }
    },
    methods: {
        ...mapMutations('cart', ['SET_CART', 'ADD_IN_CART']),
        checkTime(id) {
            let date = new Date();
            let hour = date.getUTCHours() + 7
            const options = {weekday: 'long'};
            const dayOfWeek = date.toLocaleString('en-US', options);

            if (id === 0) {
                if (dayOfWeek === 'Saturday' || dayOfWeek === 'Sunday') {
                    this.isGood = hour >= 8 && hour < 16
                } else {
                    this.isGood = hour >= 8 && hour < 12
                }
            } else if (id === 1) {
                if (dayOfWeek === 'Saturday' || dayOfWeek === 'Sunday') {
                    this.isGood = false
                } else {
                    this.isGood = hour >= 12 && hour < 16;
                }
            }
            return this.isGood
        },
        goToCatalog() {
            this.$emit('goToCatalog')
        },
        inCart(item) {
            if (this.cart.reduce((acc, item) => acc + item.count, 0) < 99) {
                let temporaryItem = item.item
                temporaryItem.count = item.count
                this.ADD_IN_CART(temporaryItem)
            }
        },
        transformAmount(item) {
            let temporaryItem = item.item
            temporaryItem.count = item.count

            this.componentCart = this.cart
            this.componentCart.push(temporaryItem)

            let index = this.componentCart.findIndex(el => el.id === temporaryItem.id)
            this.componentCart.splice(index, 1)

            index = this.componentCart.findIndex(el => el.count === 0)
            if (index !== -1) {
                this.componentCart.splice(index, 1);
            }
            this.SET_CART(this.componentCart)
        }
    },
    components: {
        catalogItem,
    },
    props: ['activeItems', 'catalogItems'],
    
    created() {
        const onResize = () => this.width = window.innerWidth;
        onResize();
        window.addEventListener('resize', onResize);
        this.$on('hook:beforeDestroy', () => window.removeEventListener('resize', onResize));
    },
}
</script>

<style scoped lang="scss">
@import "@/assets/styles/global";

.catalog-content {
    padding-bottom: 120px;
    
    @include mobile {
        padding-bottom: 60px;
    }

    .message {
        border-radius: 16px;
        padding: 40px 90px 40px 93px;
        margin-bottom: 24px;
        background: #DFE8D7;
        border-left: solid 5px $olive;

        @include mobile {
            padding: 30px 16px;
        }


        .txt {
            @include inter-400;
            color: #000;
            font-size: 20px;
            line-height: 140%;
            letter-spacing: -0.4px;

            @include mobile {
                font-size: 18px;
                font-weight: 400;
                line-height: 24.3px;
                text-align: center;

            }
        }

        &.bad {
            background: $lightGrayishRed;
            border-left: 5px solid $madderLake;
        }
    }

    .categories-title {
        @include inter-500;
        color: #000;
        font-size: 24px;
        line-height: 110%;
        letter-spacing: -0.48px;
        margin-bottom: 16px;

        &.no-message {
            margin-top: 95px;
        }

        @include mobile {
            display: none;
        }
    }


    .subcategories-title {
        color: #000;
        @include inter-400;
        line-height: 110%;
        letter-spacing: -0.36px;
        margin-bottom: 16px;

        @include mobile {
            display: none;
        }
    }

    .go-to-catalog {
        @include green-button;
        padding: 16px 64px;
        margin-top: 24px;

        &:hover {
            @include green-button-hover;

        }
    }

    .catalog-items {
        display: flex;
        flex-wrap: wrap;
        gap: 48px 40px;
        min-width: 918px;
        width: 100%;
        @include mobile {
            min-width: auto;
            gap: 30px 16px;
        }
    }

}
</style>
